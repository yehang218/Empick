name: Deploy Frontend Direct to VPC1

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "vite.config.js"
      - ".github/workflows/deploy-frontend-direct.yml"
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

env:
  AWS_REGION: ap-northeast-2
  NODE_VERSION: 18
  BUILD_PATH: dist

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“ Create Production Environment File
        run: |
          # Nginx í”„ë¡ì‹œ êµ¬ì¡° í™œìš© - /api ê²½ë¡œë¡œ ê³ ì •
          cat > .env.production << EOF
          # API Base URL (Nginx í”„ë¡ì‹œë¥¼ í†µí•´ Backendë¡œ ì „ë‹¬)
          VITE_API_BASE_URL=/api

          # ìš´ì˜í™˜ê²½ ì„¤ì •
          VITE_TIMEOUT=30000
          VITE_DEBUG_MODE=false
          VITE_LOG_LEVEL=error
          VITE_ENABLE_CACHE=true
          EOF

          echo "âœ… Production environment file created:"
          cat .env.production

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm ci --production=false
          echo "âœ… Dependencies installed successfully"

      - name: ğŸ—ï¸ Build for production
        run: |
          echo "ğŸ—ï¸ Building Vue.js application for production..."
          npm run build

          echo "ğŸ“Š Build output summary:"
          ls -la ${{ env.BUILD_PATH }}/
          du -sh ${{ env.BUILD_PATH }}/

      - name: ğŸ“¦ Create deployment package
        run: |
          echo "ğŸ“¦ Creating deployment package..."
          cd ${{ env.BUILD_PATH }}
          tar -czf ../frontend-build.tar.gz .
          cd ..
          ls -la frontend-build.tar.gz
          echo "âœ… Deployment package created"

      - name: ğŸ” Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸš€ Deploy to VPC1 Blue Instance
        run: |
          echo "ğŸš€ Deploying to Blue Instance (Primary)..."

          # Base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì „ì†¡
          BUILD_BASE64=$(base64 -w 0 frontend-build.tar.gz)

          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_BLUE_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"echo 'ğŸ”„ Starting Blue instance deployment...'\",
              \"sudo mkdir -p /tmp/frontend-deploy\",
              \"cd /tmp/frontend-deploy\",
              \"echo '$BUILD_BASE64' | base64 -d > frontend-build.tar.gz\",
              \"echo 'ğŸ“ Extracting build files...'\",
              \"tar -xzf frontend-build.tar.gz\",
              \"ls -la\",
              \"echo 'ğŸ”„ Backing up current deployment...'\",
              \"sudo mkdir -p /var/www/backup\",
              \"sudo cp -r /var/www/html /var/www/backup/\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true\",
              \"echo 'ğŸ“‚ Deploying new build...'\",
              \"sudo rm -rf /var/www/html/*\",
              \"sudo cp -r . /var/www/html/\",
              \"sudo chown -R nginx:nginx /var/www/html\",
              \"sudo chmod -R 755 /var/www/html\",
              \"echo 'ğŸ”§ Testing Nginx configuration...'\",
              \"sudo nginx -t\",
              \"echo 'ğŸ”„ Reloading Nginx...'\",
              \"sudo systemctl reload nginx\",
              \"echo 'âœ… Blue instance deployment completed successfully!'\",
              \"cd / && sudo rm -rf /tmp/frontend-deploy\"
            ]" \
            --output text

          echo "â° Waiting for Blue deployment to complete..."
          sleep 30

      - name: ğŸ§ª Health Check - Blue Instance
        run: |
          echo "ğŸ§ª Performing health check on Blue instance..."

          for i in {1..10}; do
            echo "ğŸ” Health check attempt $i/10..."
            if curl -f -s ${{ secrets.VPC1_ALB_URL }}/health; then
              echo "âœ… Blue instance health check passed!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ Blue instance health check failed after 10 attempts"
              exit 1
            fi
            sleep 15
          done

      - name: ğŸš€ Deploy to VPC1 Green Instance
        run: |
          echo "ğŸš€ Deploying to Green Instance (Secondary)..."

          # Base64ë¡œ ì¸ì½”ë”©í•˜ì—¬ ì „ì†¡
          BUILD_BASE64=$(base64 -w 0 frontend-build.tar.gz)

          aws ssm send-command \
            --instance-ids ${{ secrets.VPC1_GREEN_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[
              \"echo 'ğŸ”„ Starting Green instance deployment...'\",
              \"sudo mkdir -p /tmp/frontend-deploy\",
              \"cd /tmp/frontend-deploy\",
              \"echo '$BUILD_BASE64' | base64 -d > frontend-build.tar.gz\",
              \"echo 'ğŸ“ Extracting build files...'\",
              \"tar -xzf frontend-build.tar.gz\",
              \"ls -la\",
              \"echo 'ğŸ”„ Backing up current deployment...'\",
              \"sudo mkdir -p /var/www/backup\",
              \"sudo cp -r /var/www/html /var/www/backup/\$(date +%Y%m%d_%H%M%S) 2>/dev/null || true\",
              \"echo 'ğŸ“‚ Deploying new build...'\",
              \"sudo rm -rf /var/www/html/*\",
              \"sudo cp -r . /var/www/html/\",
              \"sudo chown -R nginx:nginx /var/www/html\",
              \"sudo chmod -R 755 /var/www/html\",
              \"echo 'ğŸ”§ Testing Nginx configuration...'\",
              \"sudo nginx -t\",
              \"echo 'ğŸ”„ Reloading Nginx...'\",
              \"sudo systemctl reload nginx\",
              \"echo 'âœ… Green instance deployment completed successfully!'\",
              \"cd / && sudo rm -rf /tmp/frontend-deploy\"
            ]" \
            --output text

          echo "â° Waiting for Green deployment to complete..."
          sleep 30

      - name: ğŸ§ª Health Check - Green Instance
        run: |
          echo "ğŸ§ª Performing health check on Green instance..."

          for i in {1..10}; do
            echo "ğŸ” Health check attempt $i/10..."
            if curl -f -s ${{ secrets.VPC1_ALB_URL }}/health; then
              echo "âœ… Green instance health check passed!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ Green instance health check failed after 10 attempts"
              exit 1
            fi
            sleep 15
          done

      - name: ğŸ§ª Frontend API Integration Test
        run: |
          echo "ğŸ§ª Testing Frontend â†’ Backend API integration..."

          # Frontend ALBë¥¼ í†µí•œ API í…ŒìŠ¤íŠ¸
          API_TEST_URL="${{ secrets.VPC1_ALB_URL }}/api/v1/auth/login"

          echo "ğŸ” Testing API endpoint: $API_TEST_URL"

          # POST ìš”ì²­ í…ŒìŠ¤íŠ¸ (ë¡œê·¸ì¸ API)
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -d '{"username":"test","password":"test"}' \
            "$API_TEST_URL")

          echo "ğŸ“Š API Response Status: $HTTP_STATUS"

          # 400ë²ˆëŒ€ ì‘ë‹µì´ë©´ ì •ìƒ (ì¸ì¦ ì‹¤íŒ¨ëŠ” ì˜ˆìƒë¨)
          if [[ $HTTP_STATUS =~ ^[24] ]]; then
            echo "âœ… API integration test passed! (Status: $HTTP_STATUS)"
          else
            echo "âŒ API integration test failed! (Status: $HTTP_STATUS)"
            echo "ğŸ”§ Checking API connectivity..."
            curl -v "$API_TEST_URL" || true
            exit 1
          fi

      - name: ğŸ‰ Deployment Summary
        run: |
          echo "ğŸ‰ Frontend Deployment Summary:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Build: SUCCESS"
          echo "âœ… Direct Deploy: SUCCESS (No S3 required)"
          echo "âœ… Blue Instance Deploy: SUCCESS"
          echo "âœ… Green Instance Deploy: SUCCESS"
          echo "âœ… Health Checks: SUCCESS"
          echo "âœ… API Integration: SUCCESS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Frontend URL: ${{ secrets.VPC1_ALB_URL }}"
          echo "ğŸ”— API Endpoint: ${{ secrets.VPC1_ALB_URL }}/api"
          echo "ğŸ¥ Health Check: ${{ secrets.VPC1_ALB_URL }}/health"
          echo "ğŸ“Š Build Size: $(du -sh ${{ env.BUILD_PATH }}/ | cut -f1)"
          echo "â° Deployment Time: $(date)"

      - name: âŒ Deployment Failed
        if: failure()
        run: |
          echo "âŒ Frontend deployment failed!"
          echo "ğŸ”§ Troubleshooting steps:"
          echo "1. Check AWS SSM Run Command status in AWS Console"
          echo "2. SSH to instances and check Nginx logs: sudo tail -f /var/log/nginx/error.log"
          echo "3. Check VPC1 EC2 IAM roles for SSM access"
          echo "4. Test Nginx configuration: sudo nginx -t"
          echo "5. Check disk space: df -h"
